import QtQuick
import QtQuick.Layouts
import QtQuick.Controls
import qs
import qs.modules.common
import qs.modules.common.widgets
import qs.modules.common.functions
import qs.services
import Quickshell
import Quickshell.Io

import qs.modules.ii.sidebarRight.quickToggles.classicStyle

FocusScope {
    id: root
    
    property string searchingText: LauncherSearch.query
    property bool showResults: searchingText != ""

    // Bottom Group States (Mirrors SidebarRight)
    property bool bottomGroupCollapsed: Persistent.states.sidebar.bottomGroup.collapsed ?? false
    property int selectedBottomTab: Persistent.states.sidebar.bottomGroup.tab ?? 0

    // Initial sync
    Component.onCompleted: {
        LauncherSearch.query = searchInput.text;
    }

    ColumnLayout {
        anchors.fill: parent
        spacing: 10

        // 1. Search Bar Widget Block
        Rectangle {
            Layout.fillWidth: true
            Layout.preferredHeight: 55
            color: Appearance.colors.colLayer1
            radius: Appearance.rounding.normal
            border.width: 1
            border.color: Appearance.colors.colLayer1Border

            RowLayout {
                anchors.fill: parent
                anchors.margins: 10
                spacing: 10

                MaterialShapeWrappedMaterialSymbol {
                    Layout.alignment: Qt.AlignVCenter
                    iconSize: Appearance.font.pixelSize.large
                    color: Appearance.colors.colPrimary
                    shape: {
                        switch(root.searchPrefixType) {
                            case Tools.SearchPrefixType.Math: return MaterialShape.Shape.PuffyDiamond;
                            case Tools.SearchPrefixType.ShellCommand: return MaterialShape.Shape.PixelCircle;
                            case Tools.SearchPrefixType.WebSearch: return MaterialShape.Shape.SoftBurst;
                            case Tools.SearchPrefixType.Clipboard: return MaterialShape.Shape.Gem;
                            case Tools.SearchPrefixType.Emojis: return MaterialShape.Shape.Sunny;
                            default: return MaterialShape.Shape.Cookie7Sided;
                        }
                    }
                    text: {
                        switch (root.searchPrefixType) {
                            case Tools.SearchPrefixType.Math: return "calculate";
                            case Tools.SearchPrefixType.ShellCommand: return "terminal";
                            case Tools.SearchPrefixType.WebSearch: return "travel_explore";
                            case Tools.SearchPrefixType.Clipboard: return "content_paste_search";
                            case Tools.SearchPrefixType.Emojis: return "add_reaction";
                            default: return "search";
                        }
                    }
                }

                ToolbarTextField {
                    id: searchInput
                    Layout.fillWidth: true
                    focus: true
                    placeholderText: Translation.tr("Search web, clipboard...")
                    text: GlobalStates.sidebarSearchText
                    background: null
                    
                    onTextChanged: {
                        GlobalStates.sidebarSearchText = text;
                        LauncherSearch.query = text;
                    }

                    Keys.onPressed: (event) => {
                        if (event.key === Qt.Key_Down && resultsList.count > 0) {
                            resultsList.focus = true;
                            resultsList.currentIndex = 0;
                            event.accepted = true;
                        }
                    }

                    onAccepted: {
                        if (resultsList.count > 0) {
                            let firstItem = resultsList.itemAtIndex(0);
                            if (firstItem && firstItem.mouseArea) {
                                firstItem.mouseArea.clicked(null);
                            }
                        }
                    }
                }
                
                IconToolbarButton {
                    visible: searchInput.text !== ""
                    text: "close"
                    implicitWidth: 30
                    implicitHeight: 30
                    onClicked: {
                        searchInput.text = ""
                        searchInput.forceActiveFocus()
                    }
                }
            }
        }

        // 2. Resource Monitor Block
        Rectangle {
            Layout.fillWidth: true
            implicitHeight: resourceColumn.implicitHeight + 16
            color: Appearance.colors.colLayer1
            radius: Appearance.rounding.normal
            border.width: 1
            border.color: Appearance.colors.colLayer1Border
            visible: !root.showResults

            ColumnLayout {
                id: resourceColumn
                anchors {
                    left: parent.left
                    right: parent.right
                    verticalCenter: parent.verticalCenter
                    margins: 12
                }
                spacing: 4

                ResourceSlider {
                    materialSymbol: "memory"
                    label: "CPU"
                    value: ResourceUsage.cpuUsage
                }

                ResourceSlider {
                    materialSymbol: "developer_board"
                    label: "RAM"
                    value: ResourceUsage.memoryUsedPercentage
                }

                ResourceSlider {
                    materialSymbol: "layers"
                    label: "Swap"
                    value: ResourceUsage.swapUsedPercentage
                }
            }
        }

        // 3. Workflow Toggles Block
        Rectangle {
            Layout.fillWidth: true
            implicitHeight: 65
            color: Appearance.colors.colLayer1
            radius: Appearance.rounding.normal
            border.width: 1
            border.color: Appearance.colors.colLayer1Border
            visible: !root.showResults

            RowLayout {
                anchors.centerIn: parent
                spacing: 10

                ButtonGroup {
                    Layout.alignment: Qt.AlignVCenter
                    spacing: 6
                    color: "transparent"
                    padding: 4

                    QuickToggleButton {
                        buttonIcon: "image_search"
                        onClicked: { 
                            GlobalStates.sidebarLeftOpen = false; 
                            Quickshell.execDetached(["qs", "-p", Quickshell.shellPath(""), "ipc", "call", "region", "search"]); 
                        }
                        StyledToolTip { text: Translation.tr("Google Lens") }
                    }
                    QuickToggleButton {
                        buttonIcon: "music_cast"
                        toggled: SongRec.running
                        onClicked: SongRec.toggleRunning()
                        StyledToolTip { text: Translation.tr("Music Recognition") }
                    }
                    QuickToggleButton {
                        buttonIcon: "content_copy"
                        onClicked: { 
                            searchInput.text = Config.options.search.prefix.clipboard; 
                            searchInput.forceActiveFocus(); 
                        }
                        StyledToolTip { text: Translation.tr("Clipboard History") }
                    }
                    QuickToggleButton {
                        buttonIcon: "add_reaction"
                        onClicked: { 
                            searchInput.text = Config.options.search.prefix.emojis; 
                            searchInput.forceActiveFocus(); 
                        }
                        StyledToolTip { text: Translation.tr("Emojis") }
                    }
                }
            }
        }

        // 4. Main Content Area (Search Results / Dynamic Content)
        Rectangle {
            Layout.fillWidth: true
            Layout.fillHeight: true
            color: Appearance.colors.colLayer1
            radius: Appearance.rounding.normal
            border.width: 1
            border.color: Appearance.colors.colLayer1Border

            Item {
                anchors.fill: parent
                anchors.margins: 5

                // Results List
                ListView {
                    id: resultsList
                    anchors.fill: parent
                    visible: root.showResults
                    clip: true
                    spacing: 6
                    highlightMoveDuration: 150
                    keyNavigationEnabled: true
                    
                    model: ScriptModel {
                        id: resultModel
                        values: []
                    }
                    
                    delegate: SearchItem {
                        required property int index
                        required property var modelData
                        width: ListView.view.width
                        entry: modelData
                        query: StringUtils.cleanOnePrefix(root.searchingText, [Config.options.search.prefix.action, Config.options.search.prefix.app, Config.options.search.prefix.clipboard, Config.options.search.prefix.emojis, Config.options.search.prefix.math, Config.options.search.prefix.shellCommand, Config.options.search.prefix.webSearch])
                        highlighted: resultsList.currentIndex === index && resultsList.activeFocus
                    }

                    Keys.onPressed: (event) => {
                        if (event.key === Qt.Key_Up && resultsList.currentIndex === 0) {
                            searchInput.forceActiveFocus();
                            event.accepted = true;
                        } else if (event.key === Qt.Key_Return || event.key === Qt.Key_Enter) {
                            let currentItem = resultsList.currentItem;
                            if (currentItem && currentItem.mouseArea) {
                                currentItem.mouseArea.clicked(null);
                            }
                            event.accepted = true;
                        }
                    }

                    Connections {
                        target: LauncherSearch
                        function onResultsChanged() {
                            let allResults = LauncherSearch.results;
                            let filtered = [];
                            for (let i = 0; i < allResults.length; i++) {
                                let item = allResults[i];
                                if (item && item.type !== Translation.tr("App")) {
                                    filtered.push(item);
                                }
                            }
                            resultModel.values = filtered;
                        }
                    }
                }

                // Placeholder / Recent Content
                ColumnLayout {
                    anchors.centerIn: parent
                    visible: !root.showResults
                    spacing: 10
                    opacity: 0.5

                    MaterialSymbol {
                        Layout.alignment: Qt.AlignHCenter
                        text: "search_insights"
                        iconSize: 48
                        color: Appearance.colors.colOnLayer1
                    }
                    StyledText {
                        Layout.alignment: Qt.AlignHCenter
                        text: Translation.tr("Type to search...")
                        font.pixelSize: Appearance.font.pixelSize.large
                        color: Appearance.colors.colOnLayer1
                    }
                }
            }
        }

        // 5. Expandable Calculator (Mirrors BottomWidgetGroup)
        Rectangle {
            id: bottomGroup
            Layout.fillWidth: true
            Layout.preferredHeight: root.bottomGroupCollapsed ? 45 : 350
            color: Appearance.colors.colLayer1
            radius: Appearance.rounding.normal
            border.width: 1
            border.color: Appearance.colors.colLayer1Border
            clip: true

            Behavior on Layout.preferredHeight {
                NumberAnimation {
                    duration: Appearance.animation.elementMove.duration
                    easing.type: Appearance.animation.elementMove.type
                    easing.bezierCurve: Appearance.animation.elementMove.bezierCurve
                }
            }

            ColumnLayout {
                anchors.fill: parent
                spacing: 0

                // Header / Toggle
                MouseArea {
                    Layout.fillWidth: true
                    Layout.preferredHeight: 45
                    onClicked: root.bottomGroupCollapsed = !root.bottomGroupCollapsed

                    RowLayout {
                        anchors.fill: parent
                        anchors.margins: 12
                        spacing: 10

                        MaterialSymbol { 
                            text: "calculate"
                            iconSize: 20
                            color: Appearance.colors.colPrimary 
                        }
                        StyledText { 
                            text: Translation.tr("Calculator")
                            font.pixelSize: Appearance.font.pixelSize.small
                            font.weight: 600
                            color: Appearance.colors.colOnLayer1
                            Layout.fillWidth: true 
                        }
                        MaterialSymbol {
                            text: root.bottomGroupCollapsed ? "keyboard_arrow_up" : "keyboard_arrow_down"
                            iconSize: 20
                            color: Appearance.colors.colOnLayer1
                        }
                    }
                }

                // Calculator Content
                Item {
                    Layout.fillWidth: true
                    Layout.fillHeight: true
                    visible: !root.bottomGroupCollapsed
                    clip: true

                    Calculator {
                        anchors.fill: parent
                        anchors.margins: 12
                    }
                }
            }
        }
    }
    
    enum SearchPrefixType { Math, ShellCommand, WebSearch, Clipboard, Emojis, DefaultSearch }

    property var searchPrefixType: {
        if (root.searchingText.startsWith(Config.options.search.prefix.math)) return Tools.SearchPrefixType.Math;
        if (root.searchingText.startsWith(Config.options.search.prefix.shellCommand)) return Tools.SearchPrefixType.ShellCommand;
        if (root.searchingText.startsWith(Config.options.search.prefix.webSearch)) return Tools.SearchPrefixType.WebSearch;
        if (root.searchingText.startsWith(Config.options.search.prefix.clipboard)) return Tools.SearchPrefixType.Clipboard;
        if (root.searchingText.startsWith(Config.options.search.prefix.emojis)) return Tools.SearchPrefixType.Emojis;
        return Tools.SearchPrefixType.DefaultSearch;
    }

    component ResourceSlider: StyledSlider { 
        id: resSlider
        required property string materialSymbol
        required property string label
        configuration: StyledSlider.Configuration.M
        enabled: false // View only
        
        MaterialSymbol {
            id: icon
            property bool nearFull: resSlider.value >= 0.9
            anchors {
                verticalCenter: parent.verticalCenter
                right: nearFull ? resSlider.handle.right : parent.right
                rightMargin: resSlider.nearFull ? 14 : 8
            }
            iconSize: 18
            color: nearFull ? Appearance.colors.colOnPrimary : Appearance.colors.colOnSecondaryContainer
            text: resSlider.materialSymbol

            Behavior on color {
                animation: Appearance.animation.elementMoveFast.colorAnimation.createObject(this)
            }
        }

        StyledText {
            text: resSlider.label
            font.pixelSize: 10
            font.weight: 800
            color: Appearance.colors.colOnSecondaryContainer
            opacity: 0.5
            anchors {
                left: parent.left
                leftMargin: 12
                verticalCenter: parent.verticalCenter
            }
        }
    }
}
